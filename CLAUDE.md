# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Medical Text De-Identification System built with Encore.ts (backend) and React (frontend) for automatically detecting and anonymizing Protected Health Information (PHI) and Personally Identifiable Information (PII) in medical text.

## Development Commands

### Running the Application

```bash
# Start backend and frontend together (recommended)
encore run

# The app will be available at http://localhost:4000
# Frontend: http://localhost:4000
# Backend API: http://localhost:4000/api
```

### Testing

```bash
# Run all tests
encore test

# Run tests from backend directory
cd backend && encore test
```

### Building

```bash
# Build for production
encore build

# Build frontend only (from backend directory)
cd backend && bun run build
```

### Frontend Client Generation

When backend types change, regenerate the frontend client:

```bash
# From backend directory
cd backend
encore gen client --target leap
```

This generates `frontend/client.ts` which provides type-safe backend API access.

### Database Migrations

Add new migrations to:
```
backend/db/migrations/XXX_description.up.sql
```

Migrations are automatically applied by Encore on `encore run`.

## Architecture

### Encore.ts Service Architecture

The backend uses Encore.ts which organizes code into **services** (not traditional REST controllers). Each service is defined by:
- `encore.service.ts` - Service declaration
- API endpoints defined with `api()` function from `encore.dev/api`

**Services:**
- `auth` - Authentication with email/password and session management
- `deid` - De-identification processing and mask list management

### Authentication Flow

The app uses **custom session-based auth** (not Clerk, despite references in README):

1. User signs up/logs in via `/auth/signup` or `/auth/login`
2. Server creates session token, stores in `sessions` table
3. Session token returned as HTTP-only cookie
4. `authHandler` validates session cookie on protected endpoints
5. User ID available via `getAuthData()` in authenticated endpoints

**Important:** The `/process` endpoint has `auth: false` - it's publicly accessible for de-identification.

### De-Identification Pipeline

Located in `backend/deid/`, the pipeline follows this flow:

```
Input Text
    ↓
Language Detection (language_detection.ts)
    ↓
Entity Detection (regex_patterns.ts + custom mask list)
    ↓
Entity Validation/Filtering (validate_entities.ts, entity_filters.ts)
    ↓
Anonymization (anonymize.ts)
    ↓
Output: deidentifiedText + entities + statistics
```

**Key files:**
- `process.ts` - Main API endpoint, orchestrates the pipeline
- `regex_patterns.ts` - Pattern-based detection for structured data (dates, emails, IDs, etc.)
- `mask_list.ts` - CRUD operations for user-specific custom keywords
- `anonymize.ts` - Applies anonymization method (redact/mask/generalize/pseudonymize)
- `types.ts` - Core TypeScript interfaces

**Entity types:** `PERSON | DATE | LOCATION | ID | CONTACT | ORGANIZATION`

**Anonymization methods:** `redact | mask | generalize | pseudonymize`

### Database Schema

PostgreSQL with two main tables:

**users:**
- `id` (BIGSERIAL) - Primary key
- `email` - Unique, used for login
- `password_hash` - SHA-256 hashed password
- Timestamps: `created_at`, `updated_at`

**sessions:**
- `user_id` - Foreign key to users
- `token` - Session token (stored in cookie)
- `expires_at` - Session expiration (30 days)

**mask_keywords:**
- `id` (BIGSERIAL) - Primary key
- `user_id` - Foreign key to users (BIGINT, not TEXT as shown in some code)
- `keyword` - The term to detect
- `entity_type` - Category (PERSON, LOCATION, etc.)
- Timestamps: `created_at`, `updated_at`

**Note:** There's a mismatch between migration schema (BIGINT foreign key) and TypeScript types (string user_id). Auth uses string user IDs, mask_list queries use strings but DB expects BIGINT.

### Frontend Architecture

React SPA with React Router:

**Pages:**
- `/` - Home (Hero.tsx)
- `/deidentify` - Single text processing
- `/batch` - Batch processing

**Key patterns:**
- `useBackend()` hook provides access to typed backend client
- Components import `backend` from `~backend/client` (generated by Encore)
- API calls return typed responses matching backend interfaces

**Authentication:**
- Session cookie automatically sent with requests
- Auth state managed via `/auth/me` endpoint

## Important Considerations

### Type Safety Between Frontend/Backend

Frontend types come from generated `client.ts`. After changing backend types:
1. Ensure backend compiles
2. Run `encore gen client --target leap` from backend directory
3. Frontend automatically gets updated types

### Database User ID Type Mismatch

The auth service uses `string` user IDs (converted from BIGINT), but database schema uses BIGINT for foreign keys. When querying mask_keywords with auth.userID (string), PostgreSQL handles the conversion. Be aware of this when writing queries.

### Password Security

Current implementation uses SHA-256 hashing without salt. For production, consider using bcrypt or Argon2.

### Public De-Identification Endpoint

The `/process` endpoint is public (`auth: false`). This allows anonymous de-identification but means:
- No rate limiting per user
- Cannot save processing history per user
- Custom mask lists must be passed in request body

## Common Tasks

### Adding a New Entity Type

1. Add to `EntityType` union in `backend/deid/types.ts`
2. Add detection pattern in `backend/deid/regex_patterns.ts`
3. Update statistics initialization in `process.ts`
4. Regenerate frontend client
5. Update frontend UI to include new entity type in filters

### Adding a New API Endpoint

1. Create endpoint in appropriate service directory (auth/ or deid/)
2. Define request/response interfaces
3. Use `api<Request, Response>()` with configuration:
   - `expose: true` - Make available externally
   - `method` - HTTP method
   - `path` - URL path (supports params like `:id`)
   - `auth` - Require authentication (true/false)
4. Regenerate frontend client

### Modifying Database Schema

1. Create new migration: `backend/db/migrations/00X_description.up.sql`
2. Migrations run automatically on `encore run`
3. For production, use Encore Cloud dashboard or `encore db migrate`

## Deployment

### Encore Cloud

```bash
# First time setup
encore auth login
git remote add encore encore://medical-text-de-identification-system-wrh2

# Deploy
git push encore
```

### GitHub Integration

Connect GitHub in Encore Cloud dashboard for automatic deployments on push. See DEVELOPMENT.md for details.
